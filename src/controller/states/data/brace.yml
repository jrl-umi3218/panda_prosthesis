Brace::Initialize:
  base: Initial
  frame: Femur
  stiffness: 10
  category: ["Initial Configuration"]

Brace::InitializeRobots:
  base: Parallel
  states: [Brace::Initialize, Choice]
  configs:
    Choice:
      category: []
      choices:
        - ["Save Calibration", "Calibrate"]
        - ["Skip Calibration", "SkipCalibration"]
        - ["Offset Calib", "OffsetCalib"]



Brace::InitializeRobots::Load:
  base: Brace::InitializeRobots
  configs:
    Brace::Initialize:
      load: true
      reset_mbc: false

Brace::InitializeRobots::NoLoad:
  base: Brace::InitializeRobots
  configs:
    Brace::Initialize:
      load: false

Brace::CalibrateRelative:
  base: CalibrateRelative
  robot: panda_brace_femur
  frame: Femur
  target_robot: brace_bottom_setup
  target_frame: Tibia
  refRobot : brace_bottom_setup
  refFrame : Link6
  # transfo between femur and tibia assuming they are in perfect contact
  femurToTibia:
    translation: [0.00401671, -0.01573711, -0.0133]
    rotation: [-0.056, 0.075, 0.088]
  # Transfo between link6 and the calibration frame
  offsetLink6:
    translation: [0,0.0,-0.07263]
    #translation: [0,0.0,0.0]


Brace::SaveCalibration:
  base: SaveCalibration
  robot: panda_brace_femur

Brace::RemoveTool:
  base: RemoveTool
  robot: panda_brace_femur
  frame: Link2

Brace::OffsetCalib:
  base: OffsetCalib
  robot: panda_brace_femur
  frame: Femur
  refRobot: brace_bottom_setup
  refFrame: Link6
  offset:
    translation: [0, 0, 0]
  completion:
    AND:
      - eval: 0.0005
      - speed: 1e-4

Brace::GoBackCalibPos:
 base: GoBackCalibPos
 robot: panda_brace_femur
 frame: Link2

Brace::GoInContact:
  base: GoInContact
  robot: panda_brace_femur
  frame: Link2
  target_robot: brace_bottom_setup
  target_frame: Tibia

Brace::PlayTrajectory:
  base: PlayTrajectory
  TrajectoryPlayer:
    FemurTrajectory:
      # Safe parameters for now
      autoplay: false
      trackForce: false
      manualForce: false
      impedanceTask:
        # dimWeight: [100, 100, 100, 1000, 1000, 1000]
        stiffness: [5000, 5000, 5000, 20000, 30000, 20000]
        gains:
          mass:
            angular: [10, 10, 10]
            linear: [10, 10, 10]
          damper:
            angular: [1000, 1000, 1000]
            linear: [1000, 1000, 1000]
          spring:
            angular: [1000, 1000, 1000]
            linear: [300, 300, 300]
          wrench:
            angular: [0, 0, 0]
            linear: [0, 0, 0]

Brace::Simulation:
  base: Meta
  transitions:
    - [InitialChoice, LoadSavedCalibration, Brace::InitializeRobots::Load, Auto]
    - [InitialChoice, StartFromCurrent, Brace::InitializeRobots::NoLoad, Auto]
    - [Brace::InitializeRobots::NoLoad, Calibrate, Brace::SaveCalibration, Auto]
    - [Brace::SaveCalibration, OK, Brace::RemoveTool, Auto]
    - [Brace::InitializeRobots::Load, SkipCalibration, ChooseTrajectory, Auto]
    - [Brace::RemoveTool, OK, InitialChoice, Auto]
    #- [Brace::RemoveTool, OK, Brace::GoBackCalibPos, Auto]
    #- [Brace::GoBackCalibPos, OK, ChooseTrajectory, Auto]
    - [Brace::InitializeRobots::Load, CalibrateRelative, Brace::CalibrateRelative, Auto]
    - [Brace::InitializeRobots::Load, OffsetCalib, Brace::OffsetCalib, Auto]
    - [Brace::OffsetCalib, OK, Brace::CalibrateRelative, Auto]
    - [Brace::CalibrateRelative, OK, Brace::GoInContact, Auto]
    - [Brace::InitializeRobots::NoLoad, SkipCalibration, ChooseTrajectory, Auto]
    - [Brace::GoInContact, OK, ChooseTrajectory, Auto]
    - [ChooseTrajectory, OK, Brace::PlayTrajectory, Auto]
    - [Brace::PlayTrajectory, PlayTrajectory, Brace::PlayTrajectory , Auto]
    - [Brace::PlayTrajectory, ChooseTrajectory, ChooseTrajectory , Auto]
